---
import { getCollection } from 'astro:content';
import Title from './Title.astro';
import RepositoryIcon from '../assets/icons/repository.svg';
import PRsOpenIcon from '../assets/icons/pr-open.svg';
import PRsClosedIcon from '../assets/icons/pr-closed.svg';

type Props = {
  class?: string;
};

// FIXIT: deduplicate the formatDate function
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString(undefined, {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

// FIXIT: Translate github PRs

const prs = await getCollection('githubPrs');

const { class: classes = '' } = Astro.props;
---

<section class={classes}>
  <Title>Github PRs</Title>

  <ul class="grid gap-4">
    {
      prs.map(({ data: pr }) => (
        <li class="border rounded-sm p-2 border-zinc-700 flex flex-col gap-2">
          <a
            class="inline-flex items-center gap-2"
            href={pr.html_url}
            target="_blank"
            rel="noopener noreferrer"
          >
            {pr.state === 'open' ? (
              <PRsOpenIcon aria-hidden class="size-5 shrink-0 text-green-600" />
            ) : (
              <PRsClosedIcon aria-hidden class="size-5 shrink-0 text-accent" />
            )}

            <span class="font-medium">{pr.title}</span>

            <span aria-hidden class="text-xs text-muted-foreground">
              #{pr.number}
            </span>
          </a>

          <div class="ml-7">
            <a
              href={pr.repository_url.replace('api.', '').replace('repos/', '')}
              target="_blank"
              class="text-muted-foreground bg-muted px-1.5 py-0.5 rounded hover:underline hover:text-white"
            >
              <RepositoryIcon class="size-4 shrink-0 " />
              {pr.repository_url.split('repos/')[1]}
            </a>
          </div>

          <div class="text-xs text-muted-foreground pl-7">
            Opened
            <time datetime={new Date(pr.created_at).toISOString()}>
              {formatDate(pr.created_at)}
            </time>
            {pr.assignee && (
              <>
                â€¢ Assigned to{' '}
                <a
                  class="text-muted-foreground hover:underline hover:text-white"
                  href={pr.assignee.html_url}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  @{pr.assignee.login}
                </a>
              </>
            )}
          </div>
        </li>
      ))
    }
  </ul>
</section>
