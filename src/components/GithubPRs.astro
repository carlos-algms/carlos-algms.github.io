---
import Title from './Title.astro';
import RepositoryIcon from '../assets/icons/repository.svg';
import PRsOpenIcon from '../assets/icons/pr-open.svg';
import PRsClosedIcon from '../assets/icons/pr-closed.svg';
import prsJson from '../content/github_prs.json';

type Props = {
  class?: string;
};

// FIXIT: deduplicate the formatDate function
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString(undefined, {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

// FIXIT: use Zod to validate the schema from Github API
// FIXIT: Translate github PRs

// const issues: GitHubIssue[] = await fetch(
//   [
//     'https://api.github.com/search/issues?q=author:carlos-algms&sort=created&order=desc&per_page=10',
//     'is:issue',
//     '-org:carlos-algms',
//     '-user:carlos-algms',
//     '-user:webdev-tools',
//     '-user:talesprates',
//   ].join('+'),
//   {},
// )
//   .then((res) => res.json())
//   .then((data) => data.items);

const prs = prsJson.items;

const { class: classes = '' } = Astro.props;
---

<section class={classes}>
  <Title>Github PRs</Title>

  <ul class="grid gap-4">
    {
      prs.map((issue) => (
        <li class="border rounded-sm p-2 border-zinc-700 flex flex-col gap-2">
          <a
            class="inline-flex items-center gap-2"
            href={issue.html_url}
            target="_blank"
            rel="noopener noreferrer"
          >
            {issue.state === 'open' ? (
              <PRsOpenIcon aria-hidden class="size-5 shrink-0 text-green-600" />
            ) : (
              <PRsClosedIcon aria-hidden class="size-5 shrink-0 text-accent" />
            )}

            <span class="font-medium">{issue.title}</span>

            <span aria-hidden class="text-xs text-muted-foreground">
              #{issue.number}
            </span>
          </a>

          <div class="ml-7">
            <a
              href={issue.repository_url
                .replace('api.', '')
                .replace('repos/', '')}
              target="_blank"
              class="text-muted-foreground bg-muted px-1.5 py-0.5 rounded hover:underline hover:text-white"
            >
              <RepositoryIcon class="size-4 shrink-0 " />
              {issue.repository_url.split('repos/')[1]}
            </a>
          </div>

          <div class="text-xs text-muted-foreground pl-7">
            Opened
            <time datetime={new Date(issue.created_at).toISOString()}>
              {formatDate(issue.created_at)}
            </time>
            {issue.assignee && (
              <>
                â€¢ Assigned to{' '}
                <a
                  class="text-muted-foreground hover:underline hover:text-white"
                  href={issue.assignee.html_url}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  @{issue.assignee.login}
                </a>
              </>
            )}
          </div>
        </li>
      ))
    }
  </ul>
</section>
